<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js" integrity="sha512-9mpsATI0KClwt+xVZfbcf2lJ8IFBAwsubJ6mI3rtULwyM3fBmQFzj0It4tGqxLOGQwGfJdk/G+fANnxfq9/cew==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>
  <script src="https://unpkg.com/vue@3"></script>
</head>
<body>
  <main class="container" id="app">
    <article class="grid" v-if="layout == 'login'">
      <div>
        <hgroup>
          <h1>Sign in</h1>
          <h2>A minimalist layout for Login pages</h2>
        </hgroup>
        <form @submit.prevent="login">
          <input type="text" name="login" placeholder="Login" aria-label="Login" autocomplete="nickname" required v-model="email">
          <input type="password" name="password" placeholder="Password" aria-label="Password" autocomplete="current-password" required v-model="password">
          <button class="contrast">Login</button>
        </form>
      </div>
      <div></div>
    </article>
    <article v-else>
      <h1>Create a User</h1>
      <form @submit.prevent="createUser">
        <input type="text" placeholder="Name" required v-model="newUser.name">
        <input type="text" placeholder="Email" required v-model="newUser.email">
        <input type="text" placeholder="Password" required v-model="newUser.password">
        <button class="contrast">Create</button>
      </form>
      <h1>Existing Users</h1>
      <table>
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
            <th scope="col">Email</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="user in users" :key="user._id">
            <td>{{ user._id }}</td>
            <td>{{ user.name }}</td>
            <td>{{ user.email }}</td>
            <td><button @click="removeUser(user._id)">Delete</button></td>
          </tr>
        </tbody>
      </table>
      <h1>Create an Article</h1>
      <form @submit.prevent="createArticle">
        <input type="text" placeholder="Title" required v-model="newArticle.title">
        <textarea placeholder="Content" required v-model="newArticle.content"></textarea>
        <select v-model="newArticle.status">
          <option value="draft">Draft</option>
          <option value="published">Published</option>
        </select>
        <button class="contrast">Create</button>
      </form>
      <h1>Existing Articles</h1>
      <table>
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Title</th>
            <th scope="col">Content</th>
            <th scope="col">Status</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="article in articles" :key="article._id">
            <td>{{ article._id }}</td>
            <td>{{ article.title }}</td>
            <td>{{ article.content }}</td>
            <td>{{ article.status }}</td>
            <td><button @click="removeArticle(article._id)">Delete</button></td>
          </tr>
        </tbody>
      </table>
    </article>
  </main>

  <script>
    const { createApp } = Vue

    const socket = io()

    createApp({
      data() {
        return {
          layout: 'login',
          email: '',
          password: '',
          users: [],
          articles: [],
          newUser: {},
          newArticle: {
            status: 'draft'
          },
          userToken: ''
        }
      },
      mounted() {
        this.load()
      },
      methods: {
        async login() {
          const { token } = await axios.post('/login', {
            email: this.email,
            password: this.password
          }).then(res => res.data)
          localStorage.setItem('token', token)
          this.load()
        },
        async load() {
          this.userToken = localStorage.getItem('token')
          if (this.userToken) {
            this.layout = 'list'
            const users = await axios.get('/api/users', {
              headers: {
                'x-access-token': this.userToken
              }
            }).then(res => res.data)
            this.users = users

            const articles = await axios.get('/api/articles', {
              headers: {
                'x-access-token': this.userToken
              }
            }).then(res => res.data)
            this.articles = articles
          }

          socket.on('user:create', (data) => {
            this.users.push(data)
          })

          socket.on('user:delete', (data) => {
            this.users = this.users.filter(user => user._id != data.id)
          })

          socket.on('article:create', (data) => {
            this.articles.push(data)
          })

          socket.on('article:delete', (data) => {
            this.articles = this.articles.filter(article => article._id != data.id)
          })
        },
        async removeUser(userId) {
          await axios.delete('/api/users/' + userId, {
              headers: {
                'x-access-token': this.userToken
              }
          })
        },
        async createUser() {
          await axios.post('/api/users', this.newUser, {
              headers: {
                'x-access-token': this.userToken
              }
          }).then(res => res.data)
        },
        async removeArticle(articleId) {
          await axios.delete('/api/articles/' + articleId, {
              headers: {
                'x-access-token': this.userToken
              }
          })
        },
        async createArticle() {
          await axios.post('/api/articles', this.newArticle, {
              headers: {
                'x-access-token': this.userToken
              }
          }).then(res => res.data)
        }
      }
    }).mount('#app')
  </script>
</body>
</html>
